The directory contains scripts to generate worst-case adversarial sequences between pairs of taxa by sampling from their edit paths. The directory contains 3 programs and we run them as described in this document. 

1. First run the program ```Make_Edit_Batches.py```. The program produces takes as input a fasta file containing sequences used to construct edit paths and an ouput directory with files containing information for running ```Get_EditPaths_Batches.py```. For example, It there are 100,000 valid pairs of sequences for computing edit paths between them, then this program creates 100 files with parameters for 1000 experiments each. All these files start with a prefix ```Batch```. We perform this step to run editpath generation efficiently in parallel on the SLURM HPC cluster. 

```
usage: Make_Edit_Batches.py [-h] -i INPUT -o OUTPUT -rdp RDP_CLASSIFIER -db
                            RDP_DB [-pre PREFIX] [-b BATCH_SIZE]
                            [-c CONFIDENCE] [-NTAX NUMBER_OF_TAXA]

This is a script to generate parameters for sampling edit paths between pairs
of taxa that have the "family" level classification. This script takes a fasta
file of sequences as input and runs the RDP classifier and returns a set of
text files that contain the parameters for running Get_EditPaths_Batches.py
concurrently on the SLURM cluster as an array job.

optional arguments:
  -h, --help            show this help message and exit
  -i INPUT, --input INPUT
                        A fasta file of sequences.
  -o OUTPUT, --output OUTPUT
                        Directory to write outputs to.
  -rdp RDP_CLASSIFIER, --rdp_classifier RDP_CLASSIFIER
                        Directory containing the RDP classifier program.
  -db RDP_DB, --rdp_DB RDP_DB
                        Directory containing the trained RDP classifier.
  -pre PREFIX, --prefix PREFIX
                        Prefix for the files containing the parameters.
                        (Default = Batch)
  -b BATCH_SIZE, --Batch_Size BATCH_SIZE
                        Size of the batch. (Default = 1000)
  -c CONFIDENCE, --confidence CONFIDENCE
                        Minimum score of the classifier to consider for
                        generating edit paths. (Default = 0.50)
  -NTAX NUMBER_OF_TAXA, --number_of_taxa NUMBER_OF_TAXA
                        Maximum number of taxa to consider, to enable
                        tractability. (Default = 100)
```

2. Upon running the ```Make_Edit_Batches.py```, run the ```Get_EditPaths_Batches.py``` script to generate edit paths. For every pair of sequences that have the same family level classification, the program runs edit paths and returns the summary of edit paths. For example, each line in the text file contains inputs pertaining to 2 sequences SA and SB with genus level labels GA and GB, from the same family F to generate edit paths. The program creates 3 files, 
	a. ```<OUTPUT>/F/Edit_Paths/SA_SB.fa```: to record a fasta file of sequences sampled from the edit path(s) between SA and SB, 
	b. ```<OUTPUT>/F/Edit_Paths_Summary/SA_SB.csv```: to summarize the taxa and confidence of classification for every sequence along the edit path, 
	c. ```<OUTPUT>/F/Edit_Paths_Taxa/SA_SB.tax.out```: results from running the RDP classifier on the edit path sequence. 
The program creates these 3 directories in the path specified under ```--output```. Within each of the the directory, the files can be found in the 

```
usage: Get_EditPaths_Batches.py [-h] -i INPUT -o OUTPUT [-t THREADS]
                                [-n NUMBER_OF_EDITPATHS] [-a ALIGNLEN] -rdp
                                RDP_CLASSIFIER -db RDP_DB

This is a script to generate edit paths between pairs of taxa that have the
same family level classification label. This script takes the batch parameters
generated by running the Make_Edit_Batches.py script as input.

optional arguments:
  -h, --help            show this help message and exit
  -i INPUT, --input INPUT
                        The text file containing parameters for generating
                        different edit paths.
  -o OUTPUT, --output OUTPUT
                        Directory to write outputs to.
  -t THREADS, --threads THREADS
                        number of threads to run concurrently. (Default = 16)
  -n NUMBER_OF_EDITPATHS, --number_of_editpaths NUMBER_OF_EDITPATHS
                        Number of edit paths to sample. (Default = 10)
  -a ALIGNLEN, --alignlen ALIGNLEN
                        fraction of query coverage to consider for generating
                        edit paths. (Default = 0.85)
  -rdp RDP_CLASSIFIER, --rdp_classifier RDP_CLASSIFIER
                        Directory containing the RDP classifier program.
  -db RDP_DB, --rdp_DB RDP_DB
                        Directory containing the trained RDP classifier.
```

3. To sample the adversarial sequences from the edit paths, run the ```Sample_Adversarial_Sequences.py```. The program takes as input ```<OUTPUT>/F/Edit_Paths_Summary/```, ```<OUTPUT>/F/Edit_Paths/``` and returns an fasta file of adversarial sequences for every pair of unique genera for the sequences in ```<OUTPUT>/F/Edit_Paths/``` and a summary file containing adversarial sequences.

```
usage: Sample_Adversarial_Sequences.py [-h] -e EDIT_PATH_DIRECTORY -s
                                       EDIT_PATH_SUMMARY -o OUTPUT_DIRECTORY
                                       -u SUMMARY_PATH
                                       [--sample_multiple_seqs] [-c NUM_SEQS]
                                       [--all]

This is a script to sample sequences from the edit paths between different
taxa pairs.These sequences are used to perform classifier sensitivity testing.
This script assumes, Get_EditPaths_Batches.py is run and has directories
containing fasta files of edit paths and a ccorresponding summary file of the
edit paths. This script retruns a fasta file of worst case adversarial
sequences and further samples multiple sequences between taxa pairs at various
points from the decision boundary upon passing the correct parameters.
Get_EditPaths_Batches.py produces <directory>/Edit_Paths/<taxa_family>/
containing fasta files of edit paths and
<directory>/Edit_Paths_Summary/<taxa_family>/ containing summary files of edit
paths for every taxon at the family in the database.

optional arguments:
  -h, --help            show this help message and exit
  -e EDIT_PATH_DIRECTORY, --edit_path_directory EDIT_PATH_DIRECTORY
                        A directory containing fasta files of edit paths.
  -s EDIT_PATH_SUMMARY, --edit_path_summary EDIT_PATH_SUMMARY
                        A directory containing summary file of edit paths.
  -o OUTPUT_DIRECTORY, --output_directory OUTPUT_DIRECTORY
                        Location of the output directory
  -u SUMMARY_PATH, --summary_path SUMMARY_PATH
                        Location to write worst-case adversarial sequences
  --sample_multiple_seqs
                        Flag to sample multiple sequences at various distances
                        from the decision boundary.
  -c NUM_SEQS, --num_seqs NUM_SEQS
                        Number of sequences to sample if
                        --sample_multiple_seqs is set to True.
  --all                 Get all adversarial sequences.
```